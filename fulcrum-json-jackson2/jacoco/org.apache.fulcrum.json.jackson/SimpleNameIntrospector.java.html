<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleNameIntrospector.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fulcrum JSON Jackson 2.x Impl</a> &gt; <a href="index.source.html" class="el_package">org.apache.fulcrum.json.jackson</a> &gt; <span class="el_source">SimpleNameIntrospector.java</span></div><h1>SimpleNameIntrospector.java</h1><pre class="source lang-java linenums">package org.apache.fulcrum.json.jackson;

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

import java.util.List;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.atomic.AtomicBoolean;

import org.apache.avalon.framework.logger.LogEnabled;
import org.apache.avalon.framework.logger.Logger;

import com.fasterxml.jackson.databind.introspect.Annotated;
import com.fasterxml.jackson.databind.introspect.AnnotatedClass;
import com.fasterxml.jackson.databind.introspect.NopAnnotationIntrospector;
import com.fasterxml.jackson.databind.ser.impl.SimpleFilterProvider;

/**
 * The intent of this custom introspector is to provide filtering capabilities
 * by using String parameters (properties and class types), which could be
 * adjusted e.g. from a scriptable context (velocity template). 
 * Class Type Filtering currently not supported except for Exclude Filter: {@link Jackson2MapperService#serializeAllExceptFilter(Object, Class, Boolean, String...)}.
 * 
 * 
 * @author gk
 * @version $Id$
 * 
 */
<span class="fc" id="L45">public class SimpleNameIntrospector extends NopAnnotationIntrospector implements LogEnabled {</span>
    /**
     * 
     */
    private static final long serialVersionUID = 1L;
    
<span class="fc" id="L51">    private List&lt;Class&lt;?&gt;&gt; filteredClasses = new CopyOnWriteArrayList&lt;&gt;();</span>
<span class="fc" id="L52">    private List&lt;String&gt; externalFilterExcludeClasses = new CopyOnWriteArrayList&lt;&gt;();</span>
<span class="fc" id="L53">    private List&lt;String&gt; externalFilterIncludeClasses = new CopyOnWriteArrayList&lt;&gt;();</span>
    // is used only for filtering by class
<span class="fc" id="L55">    private AtomicBoolean isExludeType = new AtomicBoolean(false);</span>
    
    private static Logger logger;

    /**
     * Filtering on method types.
     * 
     */
    @Override
    public Boolean isIgnorableType(AnnotatedClass ac) {
<span class="fc" id="L65">        Boolean isIgnorable = super.isIgnorableType(ac);</span>
<span class="pc bpc" id="L66" title="3 of 4 branches missed.">        if (isIgnorable == null || !isIgnorable) {</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">            if (getIsExludeType()) { // could be removed, if cleaning after call ?</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                if (!externalFilterExcludeClasses.isEmpty()</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                        &amp;&amp; externalFilterExcludeClasses.contains(ac.getName())) {</span>
<span class="nc" id="L70">                    isIgnorable = true;</span>
                }
            } else {
                // not yet used
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">                if (!externalFilterIncludeClasses.isEmpty()</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                        &amp;&amp; !externalFilterIncludeClasses.contains(ac.getName())) {</span>
                        try {
<span class="nc" id="L77">                            Class.forName(ac.getName());</span>
<span class="nc" id="L78">                            isIgnorable = true;</span>
<span class="nc" id="L79">                        } catch (ClassNotFoundException e) {</span>
                            // no clazz ignore, could NOT ignore as no filterable clazz
<span class="nc" id="L81">                        }</span>
                }
            }
        }
<span class="fc" id="L85">        return isIgnorable;</span>
    }
    /**
     * @return Object Filtering on properties returns an object, if
     *         {@link #filteredClasses} contains the class provided. The
     *         filter itself currently is {@link SimpleFilterProvider}.
     */
    @Override
    public Object findFilterId(Annotated ac) {
<span class="fc" id="L94">        Object id = super.findFilterId(ac);</span>
        // Let's default to current behavior if annotation is found:
        // Object id = super.findFilterId(ac);
        // but use simple class name if not
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        if (id == null) {</span>
<span class="fc" id="L99">            String name = ac.getName();</span>
<span class="fc" id="L100">            Class&lt;?&gt; targetClazz = ac.getRawType();</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">            if (!filteredClasses.isEmpty()</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">                    &amp;&amp; filteredClasses.contains(targetClazz)</span>
                    ) {
<span class="fc" id="L104">                logger.debug(&quot;filter applying to &quot; +name);</span>
<span class="fc" id="L105">                id = name;</span>
            } else {
                // check if target class is a child from filter class -&gt; apply filter 
<span class="nc bnc" id="L108" title="All 2 branches missed.">                for (Class&lt;?&gt; filterClazz : filteredClasses) {</span>
                    // the currently checked instance of type targetClazz is a child of the filter class filterClazz -&gt;  filter child 
<span class="nc bnc" id="L110" title="All 2 branches missed.">                    if (filterClazz.isAssignableFrom(targetClazz)) {</span>
<span class="nc" id="L111">                        logger.debug(&quot;filter applying to parent &quot; +filterClazz +&quot; matching child class &quot;+name );</span>
<span class="nc" id="L112">                        id = name;</span>
<span class="nc" id="L113">                        break;</span>
                    }
                    // the currently checked instance of type targetClazz is a parent of the filter class filterClazz -&gt; filter parent
<span class="nc bnc" id="L116" title="All 2 branches missed.">                    if (targetClazz.isAssignableFrom(filterClazz)) {</span>
<span class="nc" id="L117">                        logger.debug(&quot;filter applying to child &quot; +filterClazz+&quot; matching parent class &quot;+name);</span>
<span class="nc" id="L118">                        id = name;</span>
<span class="nc" id="L119">                        break;</span>
                    }
<span class="nc" id="L121">                }</span>
            }
        }
<span class="fc" id="L124">        return id;</span>
    }

    public List&lt;Class&lt;?&gt;&gt; getFilteredClasses() {
<span class="nc" id="L128">        return filteredClasses;</span>
    }

    public void setFilteredClass(Class&lt;?&gt; filteredClass) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (!filteredClasses.contains(filteredClass)) {</span>
<span class="nc" id="L133">            filteredClasses.add(filteredClass);</span>
        }
<span class="nc" id="L135">    }</span>

    public void setFilteredClasses(Class&lt;?&gt;... classes) {

<span class="fc bfc" id="L139" title="All 2 branches covered.">        for (int i = 0; i &lt; classes.length; i++) {</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">            if (!filteredClasses.contains(classes[i])) {</span>
<span class="fc" id="L141">                filteredClasses.add(classes[i]);</span>
            }
//            if (classes[i].getSuperclass() != null) {
//                Class superClazz = classes[i].getSuperclass();
//                if (!externalFilterClasses.contains(superClazz)) {
//                    externalFilterClasses.add(superClazz);
//                }  
//            }
        }
<span class="fc" id="L150">    }</span>

    public void removeFilteredClass(Class&lt;?&gt; filteredClass) {
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">            if (filteredClasses.contains(filteredClass)) {</span>
<span class="fc" id="L154">                filteredClasses.remove(filteredClass);</span>
            }
<span class="fc" id="L156">    }</span>
    
    public void setExternalFilterExcludeClasses(Class&lt;?&gt;... classes) {

<span class="nc bnc" id="L160" title="All 2 branches missed.">        for (int i = 0; i &lt; classes.length; i++) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (!externalFilterExcludeClasses.contains(classes[i].getName())) {</span>

<span class="nc" id="L163">                externalFilterExcludeClasses.add(classes[i].getName());</span>
            }
        }
<span class="nc" id="L166">    }</span>
    
    public void removeExternalFilterExcludeClass(Class&lt;?&gt; externalFilterClass) {
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (externalFilterExcludeClasses.contains(externalFilterClass.getName())) {</span>
<span class="nc" id="L170">            externalFilterExcludeClasses.remove(externalFilterClass.getName());</span>
        }
<span class="nc" id="L172">    }</span>
    
    public void setExternalFilterIncludeClasses(Class&lt;?&gt;... classes) {

<span class="nc bnc" id="L176" title="All 2 branches missed.">        for (int i = 0; i &lt; classes.length; i++) {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">            if (!externalFilterIncludeClasses.contains(classes[i].getName())) {</span>

<span class="nc" id="L179">                externalFilterIncludeClasses.add(classes[i].getName());</span>
            }
        }
<span class="nc" id="L182">    }</span>
    
    public void removeExternalFilterIncludeClasses(Class&lt;?&gt; externalFilterClass) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (externalFilterIncludeClasses.contains(externalFilterClass.getName())) {</span>
<span class="nc" id="L186">            externalFilterIncludeClasses.remove(externalFilterClass.getName());</span>
        }
<span class="nc" id="L188">    }</span>
    
    public boolean getIsExludeType() {
<span class="fc" id="L191">        return isExludeType.get();</span>
    }
    public void setIsExludeType(boolean isExludeType) {
<span class="nc" id="L194">        this.isExludeType.getAndSet(isExludeType);</span>
<span class="nc" id="L195">    }</span>
    @Override
    public void enableLogging(Logger logger) {
<span class="fc" id="L198">        SimpleNameIntrospector.logger = logger;        </span>
<span class="fc" id="L199">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>