<!DOCTYPE HTML>
<html lang="de">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body>
<main role="main">
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a id="line.1">package org.apache.fulcrum.json.jackson;</a>
<span class="sourceLineNo">002</span><a id="line.2"></a>
<span class="sourceLineNo">003</span><a id="line.3">/*</a>
<span class="sourceLineNo">004</span><a id="line.4"> * Licensed to the Apache Software Foundation (ASF) under one</a>
<span class="sourceLineNo">005</span><a id="line.5"> * or more contributor license agreements.  See the NOTICE file</a>
<span class="sourceLineNo">006</span><a id="line.6"> * distributed with this work for additional information</a>
<span class="sourceLineNo">007</span><a id="line.7"> * regarding copyright ownership.  The ASF licenses this file</a>
<span class="sourceLineNo">008</span><a id="line.8"> * to you under the Apache License, Version 2.0 (the</a>
<span class="sourceLineNo">009</span><a id="line.9"> * "License"); you may not use this file except in compliance</a>
<span class="sourceLineNo">010</span><a id="line.10"> * with the License.  You may obtain a copy of the License at</a>
<span class="sourceLineNo">011</span><a id="line.11"> *</a>
<span class="sourceLineNo">012</span><a id="line.12"> *   http://www.apache.org/licenses/LICENSE-2.0</a>
<span class="sourceLineNo">013</span><a id="line.13"> *</a>
<span class="sourceLineNo">014</span><a id="line.14"> * Unless required by applicable law or agreed to in writing,</a>
<span class="sourceLineNo">015</span><a id="line.15"> * software distributed under the License is distributed on an</a>
<span class="sourceLineNo">016</span><a id="line.16"> * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</a>
<span class="sourceLineNo">017</span><a id="line.17"> * KIND, either express or implied.  See the License for the</a>
<span class="sourceLineNo">018</span><a id="line.18"> * specific language governing permissions and limitations</a>
<span class="sourceLineNo">019</span><a id="line.19"> * under the License.</a>
<span class="sourceLineNo">020</span><a id="line.20"> */</a>
<span class="sourceLineNo">021</span><a id="line.21"></a>
<span class="sourceLineNo">022</span><a id="line.22"></a>
<span class="sourceLineNo">023</span><a id="line.23">import static org.junit.jupiter.api.Assertions.assertEquals;</a>
<span class="sourceLineNo">024</span><a id="line.24">import static org.junit.jupiter.api.Assertions.assertTrue;</a>
<span class="sourceLineNo">025</span><a id="line.25"></a>
<span class="sourceLineNo">026</span><a id="line.26">import java.text.SimpleDateFormat;</a>
<span class="sourceLineNo">027</span><a id="line.27">import java.util.ArrayList;</a>
<span class="sourceLineNo">028</span><a id="line.28">import java.util.Calendar;</a>
<span class="sourceLineNo">029</span><a id="line.29">import java.util.Collection;</a>
<span class="sourceLineNo">030</span><a id="line.30">import java.util.HashMap;</a>
<span class="sourceLineNo">031</span><a id="line.31">import java.util.List;</a>
<span class="sourceLineNo">032</span><a id="line.32">import java.util.Map;</a>
<span class="sourceLineNo">033</span><a id="line.33"></a>
<span class="sourceLineNo">034</span><a id="line.34">import org.apache.avalon.framework.logger.Log4JLogger;</a>
<span class="sourceLineNo">035</span><a id="line.35">import org.apache.avalon.framework.logger.Logger;</a>
<span class="sourceLineNo">036</span><a id="line.36">import org.apache.fulcrum.json.JsonService;</a>
<span class="sourceLineNo">037</span><a id="line.37">import org.apache.fulcrum.json.jackson.example.Bean;</a>
<span class="sourceLineNo">038</span><a id="line.38">import org.apache.fulcrum.json.jackson.example.BeanChild;</a>
<span class="sourceLineNo">039</span><a id="line.39">import org.apache.fulcrum.json.jackson.example.Rectangle;</a>
<span class="sourceLineNo">040</span><a id="line.40">import org.apache.fulcrum.json.jackson.example.TestClass;</a>
<span class="sourceLineNo">041</span><a id="line.41">import org.apache.fulcrum.json.jackson.filters.CustomModuleWrapper;</a>
<span class="sourceLineNo">042</span><a id="line.42">import org.apache.fulcrum.json.jackson.mixins.BeanMixin;</a>
<span class="sourceLineNo">043</span><a id="line.43">import org.apache.fulcrum.json.jackson.mixins.TypedRectangle;</a>
<span class="sourceLineNo">044</span><a id="line.44">import org.apache.fulcrum.json.jackson.serializers.TestDeserializer;</a>
<span class="sourceLineNo">045</span><a id="line.45">import org.apache.fulcrum.json.jackson.serializers.TestDummyWrapperDeserializer;</a>
<span class="sourceLineNo">046</span><a id="line.46">import org.apache.fulcrum.json.jackson.serializers.TestJsonSerializer;</a>
<span class="sourceLineNo">047</span><a id="line.47">import org.apache.fulcrum.json.jackson.serializers.TestSerializer;</a>
<span class="sourceLineNo">048</span><a id="line.48">import org.apache.fulcrum.testcontainer.BaseUnit5Test;</a>
<span class="sourceLineNo">049</span><a id="line.49">import org.apache.log4j.LogManager;</a>
<span class="sourceLineNo">050</span><a id="line.50">import org.junit.jupiter.api.BeforeEach;</a>
<span class="sourceLineNo">051</span><a id="line.51">import org.junit.jupiter.api.Test;</a>
<span class="sourceLineNo">052</span><a id="line.52">import org.junit.jupiter.api.TestReporter;</a>
<span class="sourceLineNo">053</span><a id="line.53"></a>
<span class="sourceLineNo">054</span><a id="line.54">import com.fasterxml.jackson.annotation.JsonIgnore;</a>
<span class="sourceLineNo">055</span><a id="line.55">import com.fasterxml.jackson.core.JsonProcessingException;</a>
<span class="sourceLineNo">056</span><a id="line.56">import com.fasterxml.jackson.core.type.TypeReference;</a>
<span class="sourceLineNo">057</span><a id="line.57">import com.fasterxml.jackson.databind.AnnotationIntrospector;</a>
<span class="sourceLineNo">058</span><a id="line.58">import com.fasterxml.jackson.databind.MappingJsonFactory;</a>
<span class="sourceLineNo">059</span><a id="line.59">import com.fasterxml.jackson.databind.ObjectMapper;</a>
<span class="sourceLineNo">060</span><a id="line.60">import com.fasterxml.jackson.databind.ObjectMapper.DefaultTyping;</a>
<span class="sourceLineNo">061</span><a id="line.61">import com.fasterxml.jackson.databind.introspect.AnnotationIntrospectorPair;</a>
<span class="sourceLineNo">062</span><a id="line.62">import com.fasterxml.jackson.databind.introspect.JacksonAnnotationIntrospector;</a>
<span class="sourceLineNo">063</span><a id="line.63">import com.fasterxml.jackson.databind.ser.PropertyFilter;</a>
<span class="sourceLineNo">064</span><a id="line.64">import com.fasterxml.jackson.databind.ser.impl.SimpleBeanPropertyFilter;</a>
<span class="sourceLineNo">065</span><a id="line.65">import com.fasterxml.jackson.databind.ser.impl.SimpleFilterProvider;</a>
<span class="sourceLineNo">066</span><a id="line.66"></a>
<span class="sourceLineNo">067</span><a id="line.67">/**</a>
<span class="sourceLineNo">068</span><a id="line.68"> * Jackson 2 JSON Test</a>
<span class="sourceLineNo">069</span><a id="line.69"> * </a>
<span class="sourceLineNo">070</span><a id="line.70"> * @author gk</a>
<span class="sourceLineNo">071</span><a id="line.71"> * @version $Id$</a>
<span class="sourceLineNo">072</span><a id="line.72"> */</a>
<span class="sourceLineNo">073</span><a id="line.73">public class DefaultServiceTest extends BaseUnit5Test {</a>
<span class="sourceLineNo">074</span><a id="line.74">    </a>
<span class="sourceLineNo">075</span><a id="line.75">        private JsonService sc = null;</a>
<span class="sourceLineNo">076</span><a id="line.76">        private final String preDefinedOutput = "{\"container\":{\"cf\":\"Config.xml\"},\"configurationName\":\"Config.xml\",\"name\":\"mytest\"}";</a>
<span class="sourceLineNo">077</span><a id="line.77">        Logger logger;</a>
<span class="sourceLineNo">078</span><a id="line.78"></a>
<span class="sourceLineNo">079</span><a id="line.79">        /**</a>
<span class="sourceLineNo">080</span><a id="line.80">         * Test setup</a>
<span class="sourceLineNo">081</span><a id="line.81">         * </a>
<span class="sourceLineNo">082</span><a id="line.82">         * @throws Exception generic exception</a>
<span class="sourceLineNo">083</span><a id="line.83">         */</a>
<span class="sourceLineNo">084</span><a id="line.84">        @BeforeEach</a>
<span class="sourceLineNo">085</span><a id="line.85">        public void setUp() throws Exception {</a>
<span class="sourceLineNo">086</span><a id="line.86">                logger = new Log4JLogger(LogManager.getLogger(getClass().getName()) );</a>
<span class="sourceLineNo">087</span><a id="line.87">                                //new ConsoleLogger(ConsoleLogger.LEVEL_DEBUG);</a>
<span class="sourceLineNo">088</span><a id="line.88">                sc = (JsonService) this.lookup(JsonService.ROLE);</a>
<span class="sourceLineNo">089</span><a id="line.89">        }</a>
<span class="sourceLineNo">090</span><a id="line.90"></a>
<span class="sourceLineNo">091</span><a id="line.91">        /**</a>
<span class="sourceLineNo">092</span><a id="line.92">         * Test serialization</a>
<span class="sourceLineNo">093</span><a id="line.93">         * </a>
<span class="sourceLineNo">094</span><a id="line.94">         * @throws Exception generic exception</a>
<span class="sourceLineNo">095</span><a id="line.95">         */</a>
<span class="sourceLineNo">096</span><a id="line.96">        @Test</a>
<span class="sourceLineNo">097</span><a id="line.97">        public void testSerialize() throws Exception {</a>
<span class="sourceLineNo">098</span><a id="line.98">                String serJson = sc.ser(new TestClass("mytest"));</a>
<span class="sourceLineNo">099</span><a id="line.99">                assertEquals(preDefinedOutput, serJson, "Serialization failed ");</a>
<span class="sourceLineNo">100</span><a id="line.100">        }</a>
<span class="sourceLineNo">101</span><a id="line.101"></a>
<span class="sourceLineNo">102</span><a id="line.102">        /**</a>
<span class="sourceLineNo">103</span><a id="line.103">         * @throws Exception generic exception</a>
<span class="sourceLineNo">104</span><a id="line.104">         */</a>
<span class="sourceLineNo">105</span><a id="line.105">        @Test</a>
<span class="sourceLineNo">106</span><a id="line.106">        public void testCustomSerializeWithoutServiceMapper() throws Exception {</a>
<span class="sourceLineNo">107</span><a id="line.107">                ObjectMapper objectMapper = customMapper(true);</a>
<span class="sourceLineNo">108</span><a id="line.108">                String expected = "{\"type\":\"org.apache.fulcrum.json.jackson.example.TestClass\",\"container\":{\"type\":\"java.util.HashMap\",\"cf\":\"Config.xml\"},\"configurationName\":\"Config.xml\"}";</a>
<span class="sourceLineNo">109</span><a id="line.109">                String serJson = customAllExceptFilter(objectMapper, new TestClass("mytest"), TestClass.class, "name");</a>
<span class="sourceLineNo">110</span><a id="line.110">                logger.debug("serJson:" + serJson);</a>
<span class="sourceLineNo">111</span><a id="line.111">                assertEquals(expected, serJson, "Serialization with custom mapper failed ");</a>
<span class="sourceLineNo">112</span><a id="line.112">        }</a>
<span class="sourceLineNo">113</span><a id="line.113"></a>
<span class="sourceLineNo">114</span><a id="line.114">        /**</a>
<span class="sourceLineNo">115</span><a id="line.115">         * @param withType</a>
<span class="sourceLineNo">116</span><a id="line.116">         * @return an objectMapper</a>
<span class="sourceLineNo">117</span><a id="line.117">         */</a>
<span class="sourceLineNo">118</span><a id="line.118">        private ObjectMapper customMapper(boolean withType) {</a>
<span class="sourceLineNo">119</span><a id="line.119">                // inheriting Jackson2MapperService mapper does not get the configs,</a>
<span class="sourceLineNo">120</span><a id="line.120">                // but has e.g. JsonFactory.Feature fields</a>
<span class="sourceLineNo">121</span><a id="line.121">                ObjectMapper objectMapper = new ObjectMapper(new MappingJsonFactory(((Jackson2MapperService) sc).getMapper()));</a>
<span class="sourceLineNo">122</span><a id="line.122">                // use other configuration</a>
<span class="sourceLineNo">123</span><a id="line.123">                if (withType)</a>
<span class="sourceLineNo">124</span><a id="line.124">                        objectMapper.activateDefaultTypingAsProperty(objectMapper.getPolymorphicTypeValidator(), DefaultTyping.NON_FINAL, "type");</a>
<span class="sourceLineNo">125</span><a id="line.125">                AnnotationIntrospector ai = objectMapper.getSerializationConfig().getAnnotationIntrospector();</a>
<span class="sourceLineNo">126</span><a id="line.126">                // AnnotationIntrospector is by default JacksonAnnotationIntrospector</a>
<span class="sourceLineNo">127</span><a id="line.127">                assertTrue(ai != null &amp;&amp; ai instanceof JacksonAnnotationIntrospector, "Expected Default JacksonAnnotationIntrospector");</a>
<span class="sourceLineNo">128</span><a id="line.128">                // add to allow filtering properties for non annotated class</a>
<span class="sourceLineNo">129</span><a id="line.129">                AnnotationIntrospector siai = new SimpleNameIntrospector();</a>
<span class="sourceLineNo">130</span><a id="line.130">                AnnotationIntrospector pair = new AnnotationIntrospectorPair(siai, ai);</a>
<span class="sourceLineNo">131</span><a id="line.131">                objectMapper.setAnnotationIntrospector(pair);</a>
<span class="sourceLineNo">132</span><a id="line.132">                return objectMapper;</a>
<span class="sourceLineNo">133</span><a id="line.133">        }</a>
<span class="sourceLineNo">134</span><a id="line.134"></a>
<span class="sourceLineNo">135</span><a id="line.135">        /**</a>
<span class="sourceLineNo">136</span><a id="line.136">         * @param objectMapper our object mapper</a>
<span class="sourceLineNo">137</span><a id="line.137">         * @param target       the target to serialize</a>
<span class="sourceLineNo">138</span><a id="line.138">         * @param filterClass  the filter class</a>
<span class="sourceLineNo">139</span><a id="line.139">         * @param props        properties</a>
<span class="sourceLineNo">140</span><a id="line.140">         * @return JSON string</a>
<span class="sourceLineNo">141</span><a id="line.141">         * @throws JsonProcessingException generic exception</a>
<span class="sourceLineNo">142</span><a id="line.142">         */</a>
<span class="sourceLineNo">143</span><a id="line.143">        private String customAllExceptFilter(ObjectMapper objectMapper, Object target, Class&lt;?&gt; filterClass,</a>
<span class="sourceLineNo">144</span><a id="line.144">                        String... props) throws JsonProcessingException {</a>
<span class="sourceLineNo">145</span><a id="line.145">                PropertyFilter pf = SimpleBeanPropertyFilter.SerializeExceptFilter.serializeAllExcept(props);</a>
<span class="sourceLineNo">146</span><a id="line.146">                SimpleFilterProvider filter = new SimpleFilterProvider();</a>
<span class="sourceLineNo">147</span><a id="line.147">                filter.setDefaultFilter(pf);</a>
<span class="sourceLineNo">148</span><a id="line.148">                // we know thats a pair, and the second is our simple</a>
<span class="sourceLineNo">149</span><a id="line.149">                Collection&lt;AnnotationIntrospector&gt; ais = ((AnnotationIntrospectorPair) objectMapper.getSerializationConfig()</a>
<span class="sourceLineNo">150</span><a id="line.150">                                .getAnnotationIntrospector()).allIntrospectors();</a>
<span class="sourceLineNo">151</span><a id="line.151">                for (AnnotationIntrospector ai : ais) {</a>
<span class="sourceLineNo">152</span><a id="line.152">                        if (ai instanceof SimpleNameIntrospector) {</a>
<span class="sourceLineNo">153</span><a id="line.153">                                // activate filtering</a>
<span class="sourceLineNo">154</span><a id="line.154">                                ((SimpleNameIntrospector) ai).setFilteredClasses(filterClass);</a>
<span class="sourceLineNo">155</span><a id="line.155">                        }</a>
<span class="sourceLineNo">156</span><a id="line.156">                }</a>
<span class="sourceLineNo">157</span><a id="line.157">                // alternatively we could have set it here, if ref is still available</a>
<span class="sourceLineNo">158</span><a id="line.158">                // ((SimpleNameIntrospector) siai).setFilteredClasses(filterClass);</a>
<span class="sourceLineNo">159</span><a id="line.159">                String serJson = objectMapper.writer(filter).writeValueAsString(target);</a>
<span class="sourceLineNo">160</span><a id="line.160">                // alternatively</a>
<span class="sourceLineNo">161</span><a id="line.161">                // String serJson2 =</a>
<span class="sourceLineNo">162</span><a id="line.162">                // objectMapper.setFilterProvider(filter).writeValueAsString(new</a>
<span class="sourceLineNo">163</span><a id="line.163">                // TestClass("mytest"));;</a>
<span class="sourceLineNo">164</span><a id="line.164">                // assertEquals(serJson, serJson2);</a>
<span class="sourceLineNo">165</span><a id="line.165">                return serJson;</a>
<span class="sourceLineNo">166</span><a id="line.166">        }</a>
<span class="sourceLineNo">167</span><a id="line.167"></a>
<span class="sourceLineNo">168</span><a id="line.168">        /**</a>
<span class="sourceLineNo">169</span><a id="line.169">         * @throws Exception generic exception</a>
<span class="sourceLineNo">170</span><a id="line.170">         */</a>
<span class="sourceLineNo">171</span><a id="line.171">        @Test</a>
<span class="sourceLineNo">172</span><a id="line.172">        public void testCustomSerializeListWithoutServiceMapper() throws Exception {</a>
<span class="sourceLineNo">173</span><a id="line.173">                String expected = "[{\"age\":0},{\"age\":1},{\"age\":2}]";</a>
<span class="sourceLineNo">174</span><a id="line.174">                List&lt;Bean&gt; beanList = new ArrayList&lt;Bean&gt;();</a>
<span class="sourceLineNo">175</span><a id="line.175">                for (int i = 0; i &lt; 3; i++) {</a>
<span class="sourceLineNo">176</span><a id="line.176">                        Bean bean = new Bean();</a>
<span class="sourceLineNo">177</span><a id="line.177">                        bean.setAge(i);</a>
<span class="sourceLineNo">178</span><a id="line.178">                        bean.setName("bean" + i);</a>
<span class="sourceLineNo">179</span><a id="line.179">                        beanList.add(bean);</a>
<span class="sourceLineNo">180</span><a id="line.180">                }</a>
<span class="sourceLineNo">181</span><a id="line.181">                ObjectMapper objectMapper = customMapper(false);</a>
<span class="sourceLineNo">182</span><a id="line.182">                String serJson = customAllExceptFilter(objectMapper, beanList, Bean.class, "name", "profession");</a>
<span class="sourceLineNo">183</span><a id="line.183">                logger.debug("serJson:" + serJson);</a>
<span class="sourceLineNo">184</span><a id="line.184">                assertEquals(expected, serJson);</a>
<span class="sourceLineNo">185</span><a id="line.185">        }</a>
<span class="sourceLineNo">186</span><a id="line.186"></a>
<span class="sourceLineNo">187</span><a id="line.187">        /**</a>
<span class="sourceLineNo">188</span><a id="line.188">         * @throws Exception generic exception</a>
<span class="sourceLineNo">189</span><a id="line.189">         */</a>
<span class="sourceLineNo">190</span><a id="line.190">        @Test</a>
<span class="sourceLineNo">191</span><a id="line.191">        public void testSerializeList() throws Exception {</a>
<span class="sourceLineNo">192</span><a id="line.192">                String expected = "[{\"age\":0},{\"age\":1},{\"age\":2}]";</a>
<span class="sourceLineNo">193</span><a id="line.193">                List&lt;Bean&gt; beanList = new ArrayList&lt;Bean&gt;();</a>
<span class="sourceLineNo">194</span><a id="line.194">                for (int i = 0; i &lt; 3; i++) {</a>
<span class="sourceLineNo">195</span><a id="line.195">                        Bean bean = new Bean();</a>
<span class="sourceLineNo">196</span><a id="line.196">                        bean.setAge(i);</a>
<span class="sourceLineNo">197</span><a id="line.197">                        bean.setName("bean" + i);</a>
<span class="sourceLineNo">198</span><a id="line.198">                        beanList.add(bean);</a>
<span class="sourceLineNo">199</span><a id="line.199">                }</a>
<span class="sourceLineNo">200</span><a id="line.200">                String serJson = sc.serializeAllExceptFilter(beanList, Bean.class, "name", "profession");</a>
<span class="sourceLineNo">201</span><a id="line.201">                logger.debug("serJsonByService:" + serJson);</a>
<span class="sourceLineNo">202</span><a id="line.202">                assertEquals(expected, serJson, "Serialization with service mapper failed");</a>
<span class="sourceLineNo">203</span><a id="line.203">        }</a>
<span class="sourceLineNo">204</span><a id="line.204"></a>
<span class="sourceLineNo">205</span><a id="line.205">        /**</a>
<span class="sourceLineNo">206</span><a id="line.206">         * @throws Exception generic exception</a>
<span class="sourceLineNo">207</span><a id="line.207">         */</a>
<span class="sourceLineNo">208</span><a id="line.208">        @Test</a>
<span class="sourceLineNo">209</span><a id="line.209">        // the default test class: one String field, one Map</a>
<span class="sourceLineNo">210</span><a id="line.210">        public void testSerializeExcludeNothing() throws Exception {</a>
<span class="sourceLineNo">211</span><a id="line.211">                String serJson = sc.serializeAllExceptFilter(new TestClass("mytest"));</a>
<span class="sourceLineNo">212</span><a id="line.212">                assertEquals(</a>
<span class="sourceLineNo">213</span><a id="line.213">                                "{\"container\":{\"cf\":\"Config.xml\"},\"configurationName\":\"Config.xml\",\"name\":\"mytest\"}",</a>
<span class="sourceLineNo">214</span><a id="line.214">                                serJson);</a>
<span class="sourceLineNo">215</span><a id="line.215"></a>
<span class="sourceLineNo">216</span><a id="line.216">                // test round trip</a>
<span class="sourceLineNo">217</span><a id="line.217">                TestClass result2 = checkDeserialization(serJson, TestClass.class, TextClassMixin.class);</a>
<span class="sourceLineNo">218</span><a id="line.218">                assertTrue(result2.getContainer() == null); // mixin set to ignore</a>
<span class="sourceLineNo">219</span><a id="line.219">                assertTrue(result2.getConfigurationName().equals("Config.xml"));</a>
<span class="sourceLineNo">220</span><a id="line.220">        }</a>
<span class="sourceLineNo">221</span><a id="line.221"></a>
<span class="sourceLineNo">222</span><a id="line.222">        /**</a>
<span class="sourceLineNo">223</span><a id="line.223">         * jackson does not deep exclusion of class types (by default?)</a>
<span class="sourceLineNo">224</span><a id="line.224">         * </a>
<span class="sourceLineNo">225</span><a id="line.225">         * @throws Exception generic exception</a>
<span class="sourceLineNo">226</span><a id="line.226">         */</a>
<span class="sourceLineNo">227</span><a id="line.227">        @Test</a>
<span class="sourceLineNo">228</span><a id="line.228">        public void testSerializeExcludeClass() throws Exception {</a>
<span class="sourceLineNo">229</span><a id="line.229">                String serJson = sc.serializeAllExceptFilter(new TestClass("mytest"), String.class);</a>
<span class="sourceLineNo">230</span><a id="line.230">                assertEquals("{\"container\":{\"cf\":\"Config.xml\"}}", serJson, "Serialization failed ");</a>
<span class="sourceLineNo">231</span><a id="line.231">                TestClass result2 = checkDeserialization(serJson, TestClass.class, TextClassMixin.class);</a>
<span class="sourceLineNo">232</span><a id="line.232">                assertTrue(result2.getContainer() == null);</a>
<span class="sourceLineNo">233</span><a id="line.233">        }</a>
<span class="sourceLineNo">234</span><a id="line.234"></a>
<span class="sourceLineNo">235</span><a id="line.235">        @Test</a>
<span class="sourceLineNo">236</span><a id="line.236">        public void testSerializeExcludeClassAndField() throws Exception {</a>
<span class="sourceLineNo">237</span><a id="line.237">                String serJson = ((Jackson2MapperService) sc).serializeAllExceptFilter(new TestClass("mytest"),</a>
<span class="sourceLineNo">238</span><a id="line.238">                                new Class[] { TestClass.class, String.class }, "container");</a>
<span class="sourceLineNo">239</span><a id="line.239">                assertEquals("{}", serJson);</a>
<span class="sourceLineNo">240</span><a id="line.240">                TestClass result2 = checkDeserialization(serJson, TestClass.class, TextClassMixin.class);</a>
<span class="sourceLineNo">241</span><a id="line.241">                assertTrue(result2.getContainer() == null);</a>
<span class="sourceLineNo">242</span><a id="line.242">        }</a>
<span class="sourceLineNo">243</span><a id="line.243"></a>
<span class="sourceLineNo">244</span><a id="line.244">        @Test</a>
<span class="sourceLineNo">245</span><a id="line.245">        // adding expected result to be consistent</a>
<span class="sourceLineNo">246</span><a id="line.246">        public void testSerializeExcludeClassAndFields() throws Exception {</a>
<span class="sourceLineNo">247</span><a id="line.247">                String serJson = ((Jackson2MapperService) sc).serializeAllExceptFilter(new TestClass("mytest"),</a>
<span class="sourceLineNo">248</span><a id="line.248">                                new Class[] { Map.class, String.class }, "configurationName", "name");</a>
<span class="sourceLineNo">249</span><a id="line.249">                assertEquals("{}", serJson);</a>
<span class="sourceLineNo">250</span><a id="line.250">                checkDeserialization(serJson, TestClass.class, TextClassMixin.class);</a>
<span class="sourceLineNo">251</span><a id="line.251">                String serJson2 = ((Jackson2MapperService) sc).serializeAllExceptFilter(new TestClass("mytest"), true,</a>
<span class="sourceLineNo">252</span><a id="line.252">                                "configurationName", "name");</a>
<span class="sourceLineNo">253</span><a id="line.253">                assertEquals("{}", serJson2);</a>
<span class="sourceLineNo">254</span><a id="line.254">                checkDeserialization(serJson2, TestClass.class, TextClassMixin.class);</a>
<span class="sourceLineNo">255</span><a id="line.255">        }</a>
<span class="sourceLineNo">256</span><a id="line.256"></a>
<span class="sourceLineNo">257</span><a id="line.257">        /**</a>
<span class="sourceLineNo">258</span><a id="line.258">         * Overwriting mixin</a>
<span class="sourceLineNo">259</span><a id="line.259">         * {@link com.fasterxml.jackson.databind.Module.SetupContext#setMixInAnnotations(Class, Class)}</a>
<span class="sourceLineNo">260</span><a id="line.260">         * </a>
<span class="sourceLineNo">261</span><a id="line.261">         * @throws Exception generic exception</a>
<span class="sourceLineNo">262</span><a id="line.262">         */</a>
<span class="sourceLineNo">263</span><a id="line.263">        @Test</a>
<span class="sourceLineNo">264</span><a id="line.264">        public void testSerializeExcludeField() throws Exception {</a>
<span class="sourceLineNo">265</span><a id="line.265">                String serJson = sc.serializeAllExceptFilter(new TestClass("mytest"), "configurationName");</a>
<span class="sourceLineNo">266</span><a id="line.266">                assertEquals("{\"container\":{\"cf\":\"Config.xml\"},\"name\":\"mytest\"}", serJson, "Serialization failed ");</a>
<span class="sourceLineNo">267</span><a id="line.267">                sc.addAdapter("Mixin Adapter", TestClass.class, TextClassMixin.class);</a>
<span class="sourceLineNo">268</span><a id="line.268">                // overwriting mixin with null: container is included</a>
<span class="sourceLineNo">269</span><a id="line.269">                TestClass result2 = checkDeserialization(serJson, TestClass.class, null);</a>
<span class="sourceLineNo">270</span><a id="line.270">                assertTrue(result2.getContainer() != null &amp;&amp; result2.getContainer() instanceof Map);</a>
<span class="sourceLineNo">271</span><a id="line.271">                assertTrue(result2.getName() != null);</a>
<span class="sourceLineNo">272</span><a id="line.272">        }</a>
<span class="sourceLineNo">273</span><a id="line.273"></a>
<span class="sourceLineNo">274</span><a id="line.274">        /**</a>
<span class="sourceLineNo">275</span><a id="line.275">         * @throws Exception generic exception</a>
<span class="sourceLineNo">276</span><a id="line.276">         */</a>
<span class="sourceLineNo">277</span><a id="line.277">        @Test</a>
<span class="sourceLineNo">278</span><a id="line.278">        public void testSerializeDate() throws Exception {</a>
<span class="sourceLineNo">279</span><a id="line.279">                // non default date format</a>
<span class="sourceLineNo">280</span><a id="line.280">                final SimpleDateFormat MMddyyyy = new SimpleDateFormat("MM-dd-yyyy");</a>
<span class="sourceLineNo">281</span><a id="line.281">                Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</a>
<span class="sourceLineNo">282</span><a id="line.282">                map.put("date", Calendar.getInstance().getTime());</a>
<span class="sourceLineNo">283</span><a id="line.283"></a>
<span class="sourceLineNo">284</span><a id="line.284">                sc.setDateFormat(MMddyyyy);</a>
<span class="sourceLineNo">285</span><a id="line.285">                String serJson = sc.ser(map);</a>
<span class="sourceLineNo">286</span><a id="line.286">                logger.debug("serJson:" + serJson);</a>
<span class="sourceLineNo">287</span><a id="line.287">                assertTrue(serJson.matches("\\{\"date\":\"\\d\\d-\\d\\d-\\d{4}\"\\}"),</a>
<span class="sourceLineNo">288</span><a id="line.288">                           "Serialize with Adapater failed ");</a>
<span class="sourceLineNo">289</span><a id="line.289">        }</a>
<span class="sourceLineNo">290</span><a id="line.290"></a>
<span class="sourceLineNo">291</span><a id="line.291">        /**</a>
<span class="sourceLineNo">292</span><a id="line.292">         * @throws Exception generic exception</a>
<span class="sourceLineNo">293</span><a id="line.293">         */</a>
<span class="sourceLineNo">294</span><a id="line.294">        @Test</a>
<span class="sourceLineNo">295</span><a id="line.295">        // jackson serializes size too</a>
<span class="sourceLineNo">296</span><a id="line.296">        public void testSerializeCollection() throws Exception {</a>
<span class="sourceLineNo">297</span><a id="line.297">                List&lt;Rectangle&gt; rectList = new ArrayList&lt;Rectangle&gt;();</a>
<span class="sourceLineNo">298</span><a id="line.298">                for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">299</span><a id="line.299">                        Rectangle filteredRect = new Rectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">300</span><a id="line.300">                        rectList.add(filteredRect);</a>
<span class="sourceLineNo">301</span><a id="line.301">                }</a>
<span class="sourceLineNo">302</span><a id="line.302">                String adapterSer = sc.ser(rectList);</a>
<span class="sourceLineNo">303</span><a id="line.303">                assertEquals(</a>
<span class="sourceLineNo">304</span><a id="line.304">                                "[{'w':0,'h':0,'name':'rect0','size':0},{'w':1,'h':1,'name':'rect1','size':1},{'w':2,'h':2,'name':'rect2','size':4},{'w':3,'h':3,'name':'rect3','size':9},{'w':4,'h':4,'name':'rect4','size':16},{'w':5,'h':5,'name':'rect5','size':25},{'w':6,'h':6,'name':'rect6','size':36},{'w':7,'h':7,'name':'rect7','size':49},{'w':8,'h':8,'name':'rect8','size':64},{'w':9,'h':9,'name':'rect9','size':81}]",</a>
<span class="sourceLineNo">305</span><a id="line.305">                                adapterSer.replace('"', '\''),</a>
<span class="sourceLineNo">306</span><a id="line.306">                                "collect ser failed");</a>
<span class="sourceLineNo">307</span><a id="line.307">        }</a>
<span class="sourceLineNo">308</span><a id="line.308"></a>
<span class="sourceLineNo">309</span><a id="line.309">        /**</a>
<span class="sourceLineNo">310</span><a id="line.310">         * </a>
<span class="sourceLineNo">311</span><a id="line.311">         * @param testReporter to report test infos (may propagate)</a>
<span class="sourceLineNo">312</span><a id="line.312">         * @throws Exception custom  from ser</a>
<span class="sourceLineNo">313</span><a id="line.313">         */</a>
<span class="sourceLineNo">314</span><a id="line.314">        @Test</a>
<span class="sourceLineNo">315</span><a id="line.315">        public void testSerializationCollectioPrimitiveWrapper(TestReporter testReporter) throws Exception {</a>
<span class="sourceLineNo">316</span><a id="line.316">                List&lt;Integer&gt; intList = new ArrayList&lt;Integer&gt;();</a>
<span class="sourceLineNo">317</span><a id="line.317">                for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">318</span><a id="line.318">                        Integer integer = new Integer(i * i);</a>
<span class="sourceLineNo">319</span><a id="line.319">                        intList.add(integer);</a>
<span class="sourceLineNo">320</span><a id="line.320">                }</a>
<span class="sourceLineNo">321</span><a id="line.321">                String result = sc.serializeOnlyFilter(intList, Integer.class);</a>
<span class="sourceLineNo">322</span><a id="line.322">                assertEquals("[0,1,4,9,16,25,36,49,64,81]", result, "Serialization of beans failed ");</a>
<span class="sourceLineNo">323</span><a id="line.323">                // primitives could be deserialzed without type</a>
<span class="sourceLineNo">324</span><a id="line.324">                Collection&lt;Integer&gt; result2 = checkDeserCollection(result, List.class, Integer.class, testReporter);</a>
<span class="sourceLineNo">325</span><a id="line.325">                assertTrue( !result2.isEmpty(), "expect at least one entry ");</a>
<span class="sourceLineNo">326</span><a id="line.326">                assertTrue( result2.iterator().next().getClass().isAssignableFrom(Integer.class), "result entry instance check");</a>
<span class="sourceLineNo">327</span><a id="line.327">        }</a>
<span class="sourceLineNo">328</span><a id="line.328"></a>
<span class="sourceLineNo">329</span><a id="line.329">    /**</a>
<span class="sourceLineNo">330</span><a id="line.330">     * @throws Exception generic exception</a>
<span class="sourceLineNo">331</span><a id="line.331">     */</a>
<span class="sourceLineNo">332</span><a id="line.332">    @Test</a>
<span class="sourceLineNo">333</span><a id="line.333">    public void testSerializeTypeAdapterForCollection() throws Exception {</a>
<span class="sourceLineNo">334</span><a id="line.334">        TestSerializer tser = new TestSerializer();</a>
<span class="sourceLineNo">335</span><a id="line.335">        TestDeserializer tdeSer = new TestDeserializer();</a>
<span class="sourceLineNo">336</span><a id="line.336">        CustomModuleWrapper&lt;List&lt;Rectangle&gt;&gt; cmw = new CustomModuleWrapper&lt;List&lt;Rectangle&gt;&gt;(tser, tdeSer);</a>
<span class="sourceLineNo">337</span><a id="line.337">        sc.addAdapter("Collection Adapter", ArrayList.class, cmw);</a>
<span class="sourceLineNo">338</span><a id="line.338">        List&lt;Rectangle&gt; rectList = new ArrayList&lt;Rectangle&gt;();</a>
<span class="sourceLineNo">339</span><a id="line.339">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">340</span><a id="line.340">            Rectangle filteredRect = new Rectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">341</span><a id="line.341">            rectList.add(filteredRect);</a>
<span class="sourceLineNo">342</span><a id="line.342">        }</a>
<span class="sourceLineNo">343</span><a id="line.343">        String adapterSer = sc.ser(rectList);</a>
<span class="sourceLineNo">344</span><a id="line.344">        assertEquals(</a>
<span class="sourceLineNo">345</span><a id="line.345">                "{'rect0':0,'rect1':1,'rect2':4,'rect3':9,'rect4':16,'rect5':25,'rect6':36,'rect7':49,'rect8':64,'rect9':81}",</a>
<span class="sourceLineNo">346</span><a id="line.346">                adapterSer.replace('"', '\''));</a>
<span class="sourceLineNo">347</span><a id="line.347">        // can only deserialize with type deserializer, adapter already added above</a>
<span class="sourceLineNo">348</span><a id="line.348">        List&lt;Rectangle&gt; result = sc.deSer(adapterSer, ArrayList.class);</a>
<span class="sourceLineNo">349</span><a id="line.349">        assertTrue( result.size() == 10, " expected result: 10");</a>
<span class="sourceLineNo">350</span><a id="line.350">        int nr = 3; // new Random().nextInt(10);</a>
<span class="sourceLineNo">351</span><a id="line.351">        assertTrue(result.get(nr).getName().equals("rect" + nr),</a>
<span class="sourceLineNo">352</span><a id="line.352">                   "result (" + nr + ") !=:" + result.get(nr).getName());</a>
<span class="sourceLineNo">353</span><a id="line.353">    }</a>
<span class="sourceLineNo">354</span><a id="line.354"></a>
<span class="sourceLineNo">355</span><a id="line.355">    @Test</a>
<span class="sourceLineNo">356</span><a id="line.356">    public void testMixinAdapter() throws Exception {</a>
<span class="sourceLineNo">357</span><a id="line.357">        TestJsonSerializer tser = new TestJsonSerializer();</a>
<span class="sourceLineNo">358</span><a id="line.358">        CustomModuleWrapper&lt;TestClass&gt; cmw = new CustomModuleWrapper&lt;TestClass&gt;(tser,</a>
<span class="sourceLineNo">359</span><a id="line.359">                new TestDummyWrapperDeserializer(TestClass.class));</a>
<span class="sourceLineNo">360</span><a id="line.360">        sc.addAdapter("Collection Adapter", TestClass.class, cmw);</a>
<span class="sourceLineNo">361</span><a id="line.361">        String adapterSer = sc.ser(new TestClass("mytest"));</a>
<span class="sourceLineNo">362</span><a id="line.362">        assertEquals("{\"n\":\"mytest\",\"p\":\"Config.xml\",\"c\":[]}", adapterSer,</a>
<span class="sourceLineNo">363</span><a id="line.363">                     "failed adapter serialization:");</a>
<span class="sourceLineNo">364</span><a id="line.364">    }</a>
<span class="sourceLineNo">365</span><a id="line.365"></a>
<span class="sourceLineNo">366</span><a id="line.366">    /**</a>
<span class="sourceLineNo">367</span><a id="line.367">     * @throws Exception generic exception</a>
<span class="sourceLineNo">368</span><a id="line.368">     */</a>
<span class="sourceLineNo">369</span><a id="line.369">    @Test</a>
<span class="sourceLineNo">370</span><a id="line.370">    public void testDeSerialize() throws Exception {</a>
<span class="sourceLineNo">371</span><a id="line.371">        String serJson = sc.ser(new TestClass("mytest"));</a>
<span class="sourceLineNo">372</span><a id="line.372">        Object deson = sc.deSer(serJson, TestClass.class);</a>
<span class="sourceLineNo">373</span><a id="line.373">        assertEquals(TestClass.class, deson.getClass());</a>
<span class="sourceLineNo">374</span><a id="line.374">    }</a>
<span class="sourceLineNo">375</span><a id="line.375"></a>
<span class="sourceLineNo">376</span><a id="line.376">    /**</a>
<span class="sourceLineNo">377</span><a id="line.377">     * @throws Exception generic exception</a>
<span class="sourceLineNo">378</span><a id="line.378">     */</a>
<span class="sourceLineNo">379</span><a id="line.379">    @Test</a>
<span class="sourceLineNo">380</span><a id="line.380">    public void testDeserializationCollection() throws Exception {</a>
<span class="sourceLineNo">381</span><a id="line.381">        List&lt;Rectangle&gt; rectList = new ArrayList&lt;Rectangle&gt;();</a>
<span class="sourceLineNo">382</span><a id="line.382">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">383</span><a id="line.383">            Rectangle filteredRect = new Rectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">384</span><a id="line.384">            rectList.add(filteredRect);</a>
<span class="sourceLineNo">385</span><a id="line.385">        }</a>
<span class="sourceLineNo">386</span><a id="line.386">        String serColl = sc.ser(rectList);</a>
<span class="sourceLineNo">387</span><a id="line.387">        TypeReference&lt;List&lt;Rectangle&gt;&gt; typeRef = new TypeReference&lt;List&lt;Rectangle&gt;&gt;() {</a>
<span class="sourceLineNo">388</span><a id="line.388">        };</a>
<span class="sourceLineNo">389</span><a id="line.389">        Collection&lt;Rectangle&gt; resultList0 = sc.deSerCollection(serColl, typeRef, Rectangle.class);</a>
<span class="sourceLineNo">390</span><a id="line.390">        // logger.debug("resultList0 class:" +resultList0.getClass());</a>
<span class="sourceLineNo">391</span><a id="line.391">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">392</span><a id="line.392">            assertEquals((i * i), ((List&lt;Rectangle&gt;) resultList0).get(i).getSize(),</a>
<span class="sourceLineNo">393</span><a id="line.393">                         "deser reread size failed");</a>
<span class="sourceLineNo">394</span><a id="line.394">        }</a>
<span class="sourceLineNo">395</span><a id="line.395">    }</a>
<span class="sourceLineNo">396</span><a id="line.396"></a>
<span class="sourceLineNo">397</span><a id="line.397">    /**</a>
<span class="sourceLineNo">398</span><a id="line.398">     * @throws Exception generic exception</a>
<span class="sourceLineNo">399</span><a id="line.399">     */</a>
<span class="sourceLineNo">400</span><a id="line.400">    @Test</a>
<span class="sourceLineNo">401</span><a id="line.401">    public void testDeserializationWithPlainListCollection() throws Exception {</a>
<span class="sourceLineNo">402</span><a id="line.402">        List&lt;Rectangle&gt; rectList = new ArrayList&lt;Rectangle&gt;();</a>
<span class="sourceLineNo">403</span><a id="line.403">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">404</span><a id="line.404">            Rectangle filteredRect = new Rectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">405</span><a id="line.405">            rectList.add(filteredRect);</a>
<span class="sourceLineNo">406</span><a id="line.406">        }</a>
<span class="sourceLineNo">407</span><a id="line.407">        String serColl = sc.ser(rectList);</a>
<span class="sourceLineNo">408</span><a id="line.408">        Collection&lt;Rectangle&gt; resultList0 = sc.deSerCollection(serColl, new ArrayList(), Rectangle.class);</a>
<span class="sourceLineNo">409</span><a id="line.409">        logger.debug("resultList0 class:" + resultList0.getClass());</a>
<span class="sourceLineNo">410</span><a id="line.410">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">411</span><a id="line.411">            assertEquals( (i * i), ((List&lt;Rectangle&gt;) resultList0).get(i).getSize(),</a>
<span class="sourceLineNo">412</span><a id="line.412">                          "deser reread size failed");</a>
<span class="sourceLineNo">413</span><a id="line.413">        }</a>
<span class="sourceLineNo">414</span><a id="line.414">    }</a>
<span class="sourceLineNo">415</span><a id="line.415"></a>
<span class="sourceLineNo">416</span><a id="line.416">    /**</a>
<span class="sourceLineNo">417</span><a id="line.417">     * @throws Exception generic exception</a>
<span class="sourceLineNo">418</span><a id="line.418">     */</a>
<span class="sourceLineNo">419</span><a id="line.419">    @Test</a>
<span class="sourceLineNo">420</span><a id="line.420">    public void testDeserializationWithPlainList() throws Exception {</a>
<span class="sourceLineNo">421</span><a id="line.421">        List&lt;Rectangle&gt; rectList = new ArrayList&lt;Rectangle&gt;();</a>
<span class="sourceLineNo">422</span><a id="line.422">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">423</span><a id="line.423">            Rectangle filteredRect = new Rectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">424</span><a id="line.424">            rectList.add(filteredRect);</a>
<span class="sourceLineNo">425</span><a id="line.425">        }</a>
<span class="sourceLineNo">426</span><a id="line.426">        String serColl = sc.ser(rectList);</a>
<span class="sourceLineNo">427</span><a id="line.427">        // Collection&lt;Rectangle&gt; resultList0 = sc.deSerCollection(serColl, List.class,</a>
<span class="sourceLineNo">428</span><a id="line.428">        // Rectangle.class);</a>
<span class="sourceLineNo">429</span><a id="line.429">        List&lt;Rectangle&gt; resultList0 = ((Jackson2MapperService) sc).deSerList(serColl, ArrayList.class, Rectangle.class);</a>
<span class="sourceLineNo">430</span><a id="line.430">        logger.debug("resultList0 class:" + resultList0.getClass());</a>
<span class="sourceLineNo">431</span><a id="line.431">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">432</span><a id="line.432">            assertEquals( (i * i), resultList0.get(i).getSize(),</a>
<span class="sourceLineNo">433</span><a id="line.433">                 "deser reread size failed");</a>
<span class="sourceLineNo">434</span><a id="line.434">        }</a>
<span class="sourceLineNo">435</span><a id="line.435">    }</a>
<span class="sourceLineNo">436</span><a id="line.436"></a>
<span class="sourceLineNo">437</span><a id="line.437">    /**</a>
<span class="sourceLineNo">438</span><a id="line.438">     * @throws Exception generic exception</a>
<span class="sourceLineNo">439</span><a id="line.439">     */</a>
<span class="sourceLineNo">440</span><a id="line.440">    @Test</a>
<span class="sourceLineNo">441</span><a id="line.441">    public void testDeserializationWithPlainMap() throws Exception {</a>
<span class="sourceLineNo">442</span><a id="line.442">        Map&lt;String, Rectangle&gt; rectList = new HashMap&lt;String, Rectangle&gt;();</a>
<span class="sourceLineNo">443</span><a id="line.443">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">444</span><a id="line.444">            Rectangle filteredRect = new Rectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">445</span><a id="line.445">            rectList.put("" + i, filteredRect);</a>
<span class="sourceLineNo">446</span><a id="line.446">        }</a>
<span class="sourceLineNo">447</span><a id="line.447">        String serColl = sc.ser(rectList);</a>
<span class="sourceLineNo">448</span><a id="line.448">        Map&lt;String, Rectangle&gt; resultList0 = ((Jackson2MapperService) sc).deSerMap(serColl, Map.class, String.class,</a>
<span class="sourceLineNo">449</span><a id="line.449">                Rectangle.class);</a>
<span class="sourceLineNo">450</span><a id="line.450">        logger.debug("resultList0 class:" + resultList0.getClass());</a>
<span class="sourceLineNo">451</span><a id="line.451">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">452</span><a id="line.452">            assertEquals( (i * i), resultList0.get("" + i).getSize(),</a>
<span class="sourceLineNo">453</span><a id="line.453">                          "deser reread size failed");</a>
<span class="sourceLineNo">454</span><a id="line.454">        }</a>
<span class="sourceLineNo">455</span><a id="line.455">    }</a>
<span class="sourceLineNo">456</span><a id="line.456"></a>
<span class="sourceLineNo">457</span><a id="line.457">    /**</a>
<span class="sourceLineNo">458</span><a id="line.458">     * @throws Exception generic exception</a>
<span class="sourceLineNo">459</span><a id="line.459">     */</a>
<span class="sourceLineNo">460</span><a id="line.460">    @Test</a>
<span class="sourceLineNo">461</span><a id="line.461">    public void testDeserializationTypeAdapterForCollection() throws Exception {</a>
<span class="sourceLineNo">462</span><a id="line.462">        TestSerializer tser = new TestSerializer();</a>
<span class="sourceLineNo">463</span><a id="line.463">        TestDeserializer tdeSer = new TestDeserializer();</a>
<span class="sourceLineNo">464</span><a id="line.464">        CustomModuleWrapper&lt;List&lt;Rectangle&gt;&gt; cmw = new CustomModuleWrapper&lt;List&lt;Rectangle&gt;&gt;(tser, tdeSer);</a>
<span class="sourceLineNo">465</span><a id="line.465">        sc.addAdapter("Collection Adapter", ArrayList.class, cmw);</a>
<span class="sourceLineNo">466</span><a id="line.466">        List&lt;Rectangle&gt; rectList = new ArrayList&lt;Rectangle&gt;();</a>
<span class="sourceLineNo">467</span><a id="line.467">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">468</span><a id="line.468">            Rectangle filteredRect = new Rectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">469</span><a id="line.469">            rectList.add(filteredRect);</a>
<span class="sourceLineNo">470</span><a id="line.470">        }</a>
<span class="sourceLineNo">471</span><a id="line.471">        String adapterSer = sc.ser(rectList);</a>
<span class="sourceLineNo">472</span><a id="line.472">        ArrayList&lt;Rectangle&gt; resultList0 = sc.deSer(adapterSer, ArrayList.class);</a>
<span class="sourceLineNo">473</span><a id="line.473">        for (int i = 0; i &lt; 10; i++) {</a>
<span class="sourceLineNo">474</span><a id="line.474">            assertEquals( (i * i), resultList0.get(i).getSize(),</a>
<span class="sourceLineNo">475</span><a id="line.475">                          "deser reread size failed");</a>
<span class="sourceLineNo">476</span><a id="line.476">        }</a>
<span class="sourceLineNo">477</span><a id="line.477">    }</a>
<span class="sourceLineNo">478</span><a id="line.478"></a>
<span class="sourceLineNo">479</span><a id="line.479">    /**</a>
<span class="sourceLineNo">480</span><a id="line.480">     * @throws Exception generic exception</a>
<span class="sourceLineNo">481</span><a id="line.481">     */</a>
<span class="sourceLineNo">482</span><a id="line.482">    @Test</a>
<span class="sourceLineNo">483</span><a id="line.483">    public void testSerializeWithMixinAndFilter() throws Exception {</a>
<span class="sourceLineNo">484</span><a id="line.484">        Bean filteredBean = new Bean();</a>
<span class="sourceLineNo">485</span><a id="line.485">        filteredBean.setName("joe");</a>
<span class="sourceLineNo">486</span><a id="line.486">        //</a>
<span class="sourceLineNo">487</span><a id="line.487">        sc.addAdapter("M4RBeanMixin", Bean.class, BeanMixin.class);</a>
<span class="sourceLineNo">488</span><a id="line.488">        // profession was already set to ignore, does not change</a>
<span class="sourceLineNo">489</span><a id="line.489">        String bean = sc.serializeOnlyFilter(filteredBean, Bean.class, "profession");</a>
<span class="sourceLineNo">490</span><a id="line.490">        assertEquals("{}", bean);</a>
<span class="sourceLineNo">491</span><a id="line.491">    }</a>
<span class="sourceLineNo">492</span><a id="line.492"></a>
<span class="sourceLineNo">493</span><a id="line.493">    /**</a>
<span class="sourceLineNo">494</span><a id="line.494">     * @throws Exception generic exception</a>
<span class="sourceLineNo">495</span><a id="line.495">     */</a>
<span class="sourceLineNo">496</span><a id="line.496">    @Test</a>
<span class="sourceLineNo">497</span><a id="line.497">    public void testSerializeWithOnlyFilter() throws Exception {</a>
<span class="sourceLineNo">498</span><a id="line.498"></a>
<span class="sourceLineNo">499</span><a id="line.499">        String serJson = sc.serializeOnlyFilter(new TestClass("mytest"), "configurationName");</a>
<span class="sourceLineNo">500</span><a id="line.500">        assertEquals("{\"configurationName\":\"Config.xml\"}", serJson, "Serialization failed ");</a>
<span class="sourceLineNo">501</span><a id="line.501"></a>
<span class="sourceLineNo">502</span><a id="line.502">        Rectangle filteredRectangle = new Rectangle(5, 10);</a>
<span class="sourceLineNo">503</span><a id="line.503">        filteredRectangle.setName("jim");</a>
<span class="sourceLineNo">504</span><a id="line.504">        String rectangle = sc.serializeOnlyFilter(filteredRectangle, "w");</a>
<span class="sourceLineNo">505</span><a id="line.505">        assertEquals( "{\"w\":5}", rectangle, "Ser filtered Rectangle failed ");</a>
<span class="sourceLineNo">506</span><a id="line.506">        rectangle = sc.serializeOnlyFilter(filteredRectangle, true, "w");</a>
<span class="sourceLineNo">507</span><a id="line.507">        assertEquals( "{\"w\":5}", rectangle, "Ser filtered Rectangle failed ");</a>
<span class="sourceLineNo">508</span><a id="line.508">    }</a>
<span class="sourceLineNo">509</span><a id="line.509"></a>
<span class="sourceLineNo">510</span><a id="line.510">    /**</a>
<span class="sourceLineNo">511</span><a id="line.511">     * @throws Exception generic exception</a>
<span class="sourceLineNo">512</span><a id="line.512">     */</a>
<span class="sourceLineNo">513</span><a id="line.513">    @Test</a>
<span class="sourceLineNo">514</span><a id="line.514">    public void testSerializeAllExceptANDWithOnlyFilter2() throws Exception {</a>
<span class="sourceLineNo">515</span><a id="line.515"></a>
<span class="sourceLineNo">516</span><a id="line.516">        String serJson = sc.serializeAllExceptFilter(new TestClass("mytest"), "configurationName");</a>
<span class="sourceLineNo">517</span><a id="line.517">        assertEquals( "{\"container\":{\"cf\":\"Config.xml\"},\"name\":\"mytest\"}", serJson);</a>
<span class="sourceLineNo">518</span><a id="line.518"></a>
<span class="sourceLineNo">519</span><a id="line.519">        serJson = sc.serializeOnlyFilter(new TestClass("mytest"), "configurationName");</a>
<span class="sourceLineNo">520</span><a id="line.520">        assertEquals( "{\"configurationName\":\"Config.xml\"}", serJson);</a>
<span class="sourceLineNo">521</span><a id="line.521"></a>
<span class="sourceLineNo">522</span><a id="line.522">        Rectangle filteredRectangle = new Rectangle(5, 10);</a>
<span class="sourceLineNo">523</span><a id="line.523">        filteredRectangle.setName("jim");</a>
<span class="sourceLineNo">524</span><a id="line.524">        String rectangle = sc.serializeOnlyFilter(filteredRectangle, "w");</a>
<span class="sourceLineNo">525</span><a id="line.525">        assertEquals( "{\"w\":5}", rectangle, "Ser filtered Rectangle failed ");</a>
<span class="sourceLineNo">526</span><a id="line.526">    }</a>
<span class="sourceLineNo">527</span><a id="line.527"></a>
<span class="sourceLineNo">528</span><a id="line.528">    /**</a>
<span class="sourceLineNo">529</span><a id="line.529">     * @throws Exception generic exception</a>
<span class="sourceLineNo">530</span><a id="line.530">     */</a>
<span class="sourceLineNo">531</span><a id="line.531">    @Test</a>
<span class="sourceLineNo">532</span><a id="line.532">    public void testSerializeBeanWithOnlyFilter() throws Exception {</a>
<span class="sourceLineNo">533</span><a id="line.533">        Bean bean = new BeanChild();</a>
<span class="sourceLineNo">534</span><a id="line.534">        bean.setAge(1);</a>
<span class="sourceLineNo">535</span><a id="line.535">        bean.setName("bean1");</a>
<span class="sourceLineNo">536</span><a id="line.536">        assertEquals("{\"name\":\"bean1\"}", sc.serializeOnlyFilter(bean, true, "name"));</a>
<span class="sourceLineNo">537</span><a id="line.537">        assertEquals("{\"name\":\"bean1\"}", sc.serializeOnlyFilter(bean, Bean.class, true, "name")); // parent filter</a>
<span class="sourceLineNo">538</span><a id="line.538">        assertEquals("{\"name\":\"bean1\"}", sc.serializeOnlyFilter(bean, BeanChild.class, true, "name"));</a>
<span class="sourceLineNo">539</span><a id="line.539">        assertEquals("{\"name\":\"bean1\"}", sc.serializeOnlyFilter(bean, Object.class, true, "name"));</a>
<span class="sourceLineNo">540</span><a id="line.540">        bean = new Bean();</a>
<span class="sourceLineNo">541</span><a id="line.541">        bean.setAge(0);</a>
<span class="sourceLineNo">542</span><a id="line.542">        bean.setName("bean0");</a>
<span class="sourceLineNo">543</span><a id="line.543">        assertEquals("{\"name\":\"bean0\"}", sc.serializeOnlyFilter(bean, true, "name"));</a>
<span class="sourceLineNo">544</span><a id="line.544">        assertEquals("{\"name\":\"bean0\"}", sc.serializeOnlyFilter(bean, Bean.class, true, "name"));</a>
<span class="sourceLineNo">545</span><a id="line.545">        assertEquals("{\"name\":\"bean0\"}", sc.serializeOnlyFilter(bean, BeanChild.class, true, "name"));// child</a>
<span class="sourceLineNo">546</span><a id="line.546">                                                                                                            // filter</a>
<span class="sourceLineNo">547</span><a id="line.547">        assertEquals("{\"name\":\"bean0\"}", sc.serializeOnlyFilter(bean, Object.class, true, "name"));</a>
<span class="sourceLineNo">548</span><a id="line.548">    }</a>
<span class="sourceLineNo">549</span><a id="line.549">    </a>
<span class="sourceLineNo">550</span><a id="line.550">    /**</a>
<span class="sourceLineNo">551</span><a id="line.551">     * </a>
<span class="sourceLineNo">552</span><a id="line.552">     * @param testReporter to report test infos (may propagate)</a>
<span class="sourceLineNo">553</span><a id="line.553">     * @throws Exception from ser/deser</a>
<span class="sourceLineNo">554</span><a id="line.554">     */</a>
<span class="sourceLineNo">555</span><a id="line.555">    @Test</a>
<span class="sourceLineNo">556</span><a id="line.556">    public void testSerializeCollectionWithOnlyFilterAndParentClass(TestReporter testReporter) throws Exception  {</a>
<span class="sourceLineNo">557</span><a id="line.557">        List&lt;BeanChild&gt; beanList = new ArrayList&lt;BeanChild&gt;();</a>
<span class="sourceLineNo">558</span><a id="line.558">        for (int i = 0; i &lt; 3; i++) {</a>
<span class="sourceLineNo">559</span><a id="line.559">            BeanChild bean = new BeanChild();</a>
<span class="sourceLineNo">560</span><a id="line.560">            bean.setAge(i);</a>
<span class="sourceLineNo">561</span><a id="line.561">            bean.setName("bean" + i);</a>
<span class="sourceLineNo">562</span><a id="line.562">            beanList.add(bean);</a>
<span class="sourceLineNo">563</span><a id="line.563">        }</a>
<span class="sourceLineNo">564</span><a id="line.564">        String jsonResult = sc.serializeOnlyFilter(beanList, Bean.class, true, "name");</a>
<span class="sourceLineNo">565</span><a id="line.565">        assertEquals("[{\"name\":\"bean0\"},{\"name\":\"bean1\"},{\"name\":\"bean2\"}]", jsonResult);</a>
<span class="sourceLineNo">566</span><a id="line.566">        // assertEquals("[{\"type\":\"\"},{\"type\":\"\"},{\"type\":\"\"}]",sc.serializeOnlyFilter(beanList,</a>
<span class="sourceLineNo">567</span><a id="line.567">        // BeanChild.class, true,"type"));</a>
<span class="sourceLineNo">568</span><a id="line.568"></a>
<span class="sourceLineNo">569</span><a id="line.569">        Collection&lt;BeanChild&gt; result2 = checkDeserCollection(jsonResult, List.class, BeanChild.class, testReporter);</a>
<span class="sourceLineNo">570</span><a id="line.570">        assertTrue( !result2.isEmpty());</a>
<span class="sourceLineNo">571</span><a id="line.571">        assertTrue(</a>
<span class="sourceLineNo">572</span><a id="line.572">                result2.iterator().next().getClass().isAssignableFrom(BeanChild.class),</a>
<span class="sourceLineNo">573</span><a id="line.573">                "result entry instance check");</a>
<span class="sourceLineNo">574</span><a id="line.574">    }</a>
<span class="sourceLineNo">575</span><a id="line.575"></a>
<span class="sourceLineNo">576</span><a id="line.576">    /**</a>
<span class="sourceLineNo">577</span><a id="line.577">     * </a>
<span class="sourceLineNo">578</span><a id="line.578">     * @param testReporter to report test infos (may propagate)</a>
<span class="sourceLineNo">579</span><a id="line.579">     * @throws Exception generic type from ser/deser</a>
<span class="sourceLineNo">580</span><a id="line.580">     */</a>
<span class="sourceLineNo">581</span><a id="line.581">    @Test</a>
<span class="sourceLineNo">582</span><a id="line.582">    public void testSerializeCollectionWithOnlyFilterAndExactClass(TestReporter testReporter) throws Exception {</a>
<span class="sourceLineNo">583</span><a id="line.583">        List&lt;Bean&gt; beanList = new ArrayList&lt;Bean&gt;();</a>
<span class="sourceLineNo">584</span><a id="line.584">        for (int i = 0; i &lt; 3; i++) {</a>
<span class="sourceLineNo">585</span><a id="line.585">            Bean bean = new BeanChild();</a>
<span class="sourceLineNo">586</span><a id="line.586">            bean.setAge(i);</a>
<span class="sourceLineNo">587</span><a id="line.587">            bean.setName("bean" + i);</a>
<span class="sourceLineNo">588</span><a id="line.588">            beanList.add(bean);</a>
<span class="sourceLineNo">589</span><a id="line.589">        }</a>
<span class="sourceLineNo">590</span><a id="line.590">        String jsonResult = sc.serializeOnlyFilter(beanList, BeanChild.class, true, "name");</a>
<span class="sourceLineNo">591</span><a id="line.591">        assertEquals("[{\"name\":\"bean0\"},{\"name\":\"bean1\"},{\"name\":\"bean2\"}]", jsonResult);</a>
<span class="sourceLineNo">592</span><a id="line.592">        // assertEquals("[{\"type\":\"\"},{\"type\":\"\"},{\"type\":\"\"}]",sc.serializeOnlyFilter(beanList,</a>
<span class="sourceLineNo">593</span><a id="line.593">        // BeanChild.class, true,"type"));</a>
<span class="sourceLineNo">594</span><a id="line.594">        Collection&lt;Bean&gt; result2 = checkDeserCollection(jsonResult, List.class, Bean.class, testReporter);</a>
<span class="sourceLineNo">595</span><a id="line.595">        assertTrue( !result2.isEmpty(), "expect at least one entry ");</a>
<span class="sourceLineNo">596</span><a id="line.596">        assertTrue( result2.iterator().next().getClass().isAssignableFrom(Bean.class), "result entry instance check");</a>
<span class="sourceLineNo">597</span><a id="line.597">    }</a>
<span class="sourceLineNo">598</span><a id="line.598"></a>
<span class="sourceLineNo">599</span><a id="line.599">    /**</a>
<span class="sourceLineNo">600</span><a id="line.600">     * </a>
<span class="sourceLineNo">601</span><a id="line.601">     * @param testReporter to report test infos (may propagate)</a>
<span class="sourceLineNo">602</span><a id="line.602">     * @throws Exception generic type from ser/deser</a>
<span class="sourceLineNo">603</span><a id="line.603">     */</a>
<span class="sourceLineNo">604</span><a id="line.604">    @Test</a>
<span class="sourceLineNo">605</span><a id="line.605">    public void testSerializeCollectionWithOnlyFilterWithChildClass(TestReporter testReporter) throws Exception {</a>
<span class="sourceLineNo">606</span><a id="line.606">        List&lt;Bean&gt; beanList = new ArrayList&lt;Bean&gt;();</a>
<span class="sourceLineNo">607</span><a id="line.607">        for (int i = 0; i &lt; 3; i++) {</a>
<span class="sourceLineNo">608</span><a id="line.608">            Bean bean = new Bean();</a>
<span class="sourceLineNo">609</span><a id="line.609">            bean.setAge(i);</a>
<span class="sourceLineNo">610</span><a id="line.610">            bean.setName("bean" + i);</a>
<span class="sourceLineNo">611</span><a id="line.611">            beanList.add(bean);</a>
<span class="sourceLineNo">612</span><a id="line.612">        }</a>
<span class="sourceLineNo">613</span><a id="line.613">        String jsonResult = sc.serializeOnlyFilter(beanList, BeanChild.class, true, "name");</a>
<span class="sourceLineNo">614</span><a id="line.614">        assertEquals("[{\"name\":\"bean0\"},{\"name\":\"bean1\"},{\"name\":\"bean2\"}]", jsonResult);</a>
<span class="sourceLineNo">615</span><a id="line.615">        // assertEquals("[{\"type\":\"\"},{\"type\":\"\"},{\"type\":\"\"}]",sc.serializeOnlyFilter(beanList,</a>
<span class="sourceLineNo">616</span><a id="line.616">        // BeanChild.class, true,"type"));</a>
<span class="sourceLineNo">617</span><a id="line.617">        Collection&lt;Bean&gt; result2 = checkDeserCollection(jsonResult, List.class, Bean.class, testReporter);</a>
<span class="sourceLineNo">618</span><a id="line.618">        assertTrue( !result2.isEmpty(), "expect at least one entry ");</a>
<span class="sourceLineNo">619</span><a id="line.619">        assertTrue( result2.iterator().next().getClass().isAssignableFrom(Bean.class), "result entry instance check");</a>
<span class="sourceLineNo">620</span><a id="line.620">    }</a>
<span class="sourceLineNo">621</span><a id="line.621"></a>
<span class="sourceLineNo">622</span><a id="line.622">    /**</a>
<span class="sourceLineNo">623</span><a id="line.623">     * @throws Exception generic exception</a>
<span class="sourceLineNo">624</span><a id="line.624">     * </a>
<span class="sourceLineNo">625</span><a id="line.625">     */</a>
<span class="sourceLineNo">626</span><a id="line.626">    @Test</a>
<span class="sourceLineNo">627</span><a id="line.627">    public void testSerializeCollectionWithOnlyFilterAndType() throws Exception {</a>
<span class="sourceLineNo">628</span><a id="line.628"></a>
<span class="sourceLineNo">629</span><a id="line.629">        List&lt;TypedRectangle&gt; rectList = new ArrayList&lt;TypedRectangle&gt;();</a>
<span class="sourceLineNo">630</span><a id="line.630">        for (int i = 0; i &lt; 2; i++) {</a>
<span class="sourceLineNo">631</span><a id="line.631">            TypedRectangle filteredRect = new TypedRectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">632</span><a id="line.632">            rectList.add(filteredRect);</a>
<span class="sourceLineNo">633</span><a id="line.633">        }</a>
<span class="sourceLineNo">634</span><a id="line.634">        Class&lt;?&gt; clazz = Class.forName("org.apache.fulcrum.json.jackson.mixins.TypedRectangle");</a>
<span class="sourceLineNo">635</span><a id="line.635">        // </a>
<span class="sourceLineNo">636</span><a id="line.636">        String jsonResult = sc.serializeOnlyFilter(rectList, clazz, true, "w");</a>
<span class="sourceLineNo">637</span><a id="line.637">        assertEquals("[{\"w\":0},{\"w\":1}]", jsonResult);</a>
<span class="sourceLineNo">638</span><a id="line.638">        // could not deserialize easily with missing property type</a>
<span class="sourceLineNo">639</span><a id="line.639">    }</a>
<span class="sourceLineNo">640</span><a id="line.640"></a>
<span class="sourceLineNo">641</span><a id="line.641">    /**</a>
<span class="sourceLineNo">642</span><a id="line.642">     * </a>
<span class="sourceLineNo">643</span><a id="line.643">     * This test was a workaround for no type cft. https://github.com/FasterXML/jackson-databind/issues/303</a>
<span class="sourceLineNo">644</span><a id="line.644">     * </a>
<span class="sourceLineNo">645</span><a id="line.645">     * and is not supported in v &amp;gt; 10.2 (assign a type to Object). Use e.g. type references</a>
<span class="sourceLineNo">646</span><a id="line.646">     * </a>
<span class="sourceLineNo">647</span><a id="line.647">     * {@link #testSerializeCollectionWithTypedReference(TestReporter)} or write a custom serializer</a>
<span class="sourceLineNo">648</span><a id="line.648">     * </a>
<span class="sourceLineNo">649</span><a id="line.649">     * @throws Exception generic type</a>
<span class="sourceLineNo">650</span><a id="line.650">     */</a>
<span class="sourceLineNo">651</span><a id="line.651">    @Deprecated</a>
<span class="sourceLineNo">652</span><a id="line.652">    public void testSerializeCollectionWithOnlyFilterAndMixin() throws Exception {</a>
<span class="sourceLineNo">653</span><a id="line.653"></a>
<span class="sourceLineNo">654</span><a id="line.654">        List&lt;TypedRectangle&gt; rectList = new ArrayList&lt;TypedRectangle&gt;();</a>
<span class="sourceLineNo">655</span><a id="line.655">        for (int i = 0; i &lt; 2; i++) {</a>
<span class="sourceLineNo">656</span><a id="line.656">            TypedRectangle filteredRect = new TypedRectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">657</span><a id="line.657">            rectList.add(filteredRect);</a>
<span class="sourceLineNo">658</span><a id="line.658">        }</a>
<span class="sourceLineNo">659</span><a id="line.659">        Class&lt;?&gt; clazz = Class.forName("org.apache.fulcrum.json.jackson.mixins.TypedRectangle");</a>
<span class="sourceLineNo">660</span><a id="line.660">        sc.addAdapter("Collection Adapter", Object.class, TypedRectangle.class);</a>
<span class="sourceLineNo">661</span><a id="line.661">        System.out.println( "********++********** sc" + sc );</a>
<span class="sourceLineNo">662</span><a id="line.662">        String result = sc.serializeOnlyFilter(rectList, clazz, true, "w");</a>
<span class="sourceLineNo">663</span><a id="line.663">        assertEquals(</a>
<span class="sourceLineNo">664</span><a id="line.664">                "[\"java.util.ArrayList\",[{\"type\":\"org.apache.fulcrum.json.jackson.mixins.TypedRectangle\",\"w\":0},{\"type\":\"org.apache.fulcrum.json.jackson.mixins.TypedRectangle\",\"w\":1}]]",</a>
<span class="sourceLineNo">665</span><a id="line.665">                result);</a>
<span class="sourceLineNo">666</span><a id="line.666">    }</a>
<span class="sourceLineNo">667</span><a id="line.667"></a>
<span class="sourceLineNo">668</span><a id="line.668">    /**</a>
<span class="sourceLineNo">669</span><a id="line.669">     * </a>
<span class="sourceLineNo">670</span><a id="line.670">     * @param testReporter to report test infos (may propagate)</a>
<span class="sourceLineNo">671</span><a id="line.671">     * @throws Exception generic type  from ser/deser</a>
<span class="sourceLineNo">672</span><a id="line.672">     */</a>
<span class="sourceLineNo">673</span><a id="line.673">    @Test</a>
<span class="sourceLineNo">674</span><a id="line.674">    public void testSerializeCollectionWithTypedReference(TestReporter testReporter) throws Exception {</a>
<span class="sourceLineNo">675</span><a id="line.675"></a>
<span class="sourceLineNo">676</span><a id="line.676">        List&lt;TypedRectangle&gt; rectList = new ArrayList&lt;TypedRectangle&gt;();</a>
<span class="sourceLineNo">677</span><a id="line.677">        for (int i = 0; i &lt; 2; i++) {</a>
<span class="sourceLineNo">678</span><a id="line.678">            TypedRectangle filteredRect = new TypedRectangle(i, i, "rect" + i);</a>
<span class="sourceLineNo">679</span><a id="line.679">            rectList.add(filteredRect);</a>
<span class="sourceLineNo">680</span><a id="line.680">        }</a>
<span class="sourceLineNo">681</span><a id="line.681">        TypeReference&lt;List&lt;TypedRectangle&gt;&gt; typeRef = new TypeReference&lt;List&lt;TypedRectangle&gt;&gt;() {</a>
<span class="sourceLineNo">682</span><a id="line.682">        };</a>
<span class="sourceLineNo">683</span><a id="line.683">        String jsonResult = ((Jackson2MapperService) sc).serCollectionWithTypeReference(rectList, typeRef, false);</a>
<span class="sourceLineNo">684</span><a id="line.684">        logger.debug("aa:" + jsonResult);</a>
<span class="sourceLineNo">685</span><a id="line.685">        // could deserialize with type information</a>
<span class="sourceLineNo">686</span><a id="line.686">        Collection&lt;TypedRectangle&gt; result2 = checkDeserCollection(jsonResult, List.class, TypedRectangle.class, testReporter);</a>
<span class="sourceLineNo">687</span><a id="line.687">        assertTrue( !result2.isEmpty(), "expect at least one entry ");</a>
<span class="sourceLineNo">688</span><a id="line.688">        assertTrue(</a>
<span class="sourceLineNo">689</span><a id="line.689">                result2.iterator().next().getClass().isAssignableFrom(TypedRectangle.class),</a>
<span class="sourceLineNo">690</span><a id="line.690">                "result entry instance check");</a>
<span class="sourceLineNo">691</span><a id="line.691"></a>
<span class="sourceLineNo">692</span><a id="line.692">    }</a>
<span class="sourceLineNo">693</span><a id="line.693"></a>
<span class="sourceLineNo">694</span><a id="line.694">    @Test</a>
<span class="sourceLineNo">695</span><a id="line.695">    // jackson does not escape anything, except double quotes and backslash,</a>
<span class="sourceLineNo">696</span><a id="line.696">    // additional characters could be provided</a>
<span class="sourceLineNo">697</span><a id="line.697">    // by activationg escapeCharsGlobal xml characters are added</a>
<span class="sourceLineNo">698</span><a id="line.698">    public void testSerializeHTMLEscape() throws Exception {</a>
<span class="sourceLineNo">699</span><a id="line.699">        Rectangle filteredRect = new Rectangle(2, 3,</a>
<span class="sourceLineNo">700</span><a id="line.700">                "rectÜber&lt;strong&gt;StockundStein &amp;iuml;&lt;/strong&gt;&lt;/script&gt;&lt;script&gt;alert('xss')&lt;/script&gt;" + 0);</a>
<span class="sourceLineNo">701</span><a id="line.701">        String adapterSer = sc.ser(filteredRect);</a>
<span class="sourceLineNo">702</span><a id="line.702">        logger.debug("Escaped serialized string:" + adapterSer);</a>
<span class="sourceLineNo">703</span><a id="line.703">        assertEquals(</a>
<span class="sourceLineNo">704</span><a id="line.704">                "{'w':2,'h':3,'name':'rectÜber\\u003Cstrong\\u003EStockundStein \\u0026iuml;\\u003C/strong\\u003E\\u003C/script\\u003E\\u003Cscript\\u003Ealert(\\u0027xss\\u0027)\\u003C/script\\u003E0','size':6}",</a>
<span class="sourceLineNo">705</span><a id="line.705">                adapterSer.replace('"', '\''),</a>
<span class="sourceLineNo">706</span><a id="line.706">                "escaped html entities ser expected, iei &lt;,&gt;,&amp;,\\ escaped (requires escapeCharsGlobal in json component configuration");</a>
<span class="sourceLineNo">707</span><a id="line.707">        // you could set your own escapes here in class esc extending from</a>
<span class="sourceLineNo">708</span><a id="line.708">        // CharacterEscapes.</a>
<span class="sourceLineNo">709</span><a id="line.709">        // ((Jackson2MapperService)sc).getMapper().getFactory().setCharacterEscapes(esc</a>
<span class="sourceLineNo">710</span><a id="line.710">        // ) );</a>
<span class="sourceLineNo">711</span><a id="line.711">    }</a>
<span class="sourceLineNo">712</span><a id="line.712"></a>
<span class="sourceLineNo">713</span><a id="line.713">    /**</a>
<span class="sourceLineNo">714</span><a id="line.714">     * checks if string serJson is deserializable to class target with adapter mixin</a>
<span class="sourceLineNo">715</span><a id="line.715">     * and returns result.</a>
<span class="sourceLineNo">716</span><a id="line.716">     * </a>
<span class="sourceLineNo">717</span><a id="line.717">     * @param serJson JSON String to be tested</a>
<span class="sourceLineNo">718</span><a id="line.718">     * @param target  class to be expected</a>
<span class="sourceLineNo">719</span><a id="line.719">     * @param mixin   adapter set</a>
<span class="sourceLineNo">720</span><a id="line.720">     * @return the resulting instance</a>
<span class="sourceLineNo">721</span><a id="line.721">     * @throws Exception</a>
<span class="sourceLineNo">722</span><a id="line.722">     */</a>
<span class="sourceLineNo">723</span><a id="line.723">    private &lt;T&gt; T checkDeserialization(String serJson, Class&lt;T&gt; target, Class mixin) throws Exception {</a>
<span class="sourceLineNo">724</span><a id="line.724">        sc.addAdapter("Mixin Adapter", target, mixin);</a>
<span class="sourceLineNo">725</span><a id="line.725">        T result = sc.deSer(serJson, target);</a>
<span class="sourceLineNo">726</span><a id="line.726">        assertTrue( target.isAssignableFrom(result.getClass()), "Result Instance Check");</a>
<span class="sourceLineNo">727</span><a id="line.727">        return result;</a>
<span class="sourceLineNo">728</span><a id="line.728">    }</a>
<span class="sourceLineNo">729</span><a id="line.729"></a>
<span class="sourceLineNo">730</span><a id="line.730">    private &lt;U&gt; Collection&lt;U&gt; checkDeserCollection(String serJson, Class&lt;? extends Collection&gt; collClass,</a>
<span class="sourceLineNo">731</span><a id="line.731">            Class&lt;U&gt; entryClass, TestReporter testReporter) throws Exception {</a>
<span class="sourceLineNo">732</span><a id="line.732">        Collection&lt;U&gt; result = ((Jackson2MapperService) sc).deSerCollectionWithType(serJson, collClass, entryClass);</a>
<span class="sourceLineNo">733</span><a id="line.733">        testReporter.publishEntry("result:"+ result + " is of type: "+ result.getClass() + "and assignable from "+ collClass);</a>
<span class="sourceLineNo">734</span><a id="line.734">        assertTrue(collClass.isAssignableFrom(result.getClass()),</a>
<span class="sourceLineNo">735</span><a id="line.735">                "Result Instance Check failed for result class " + result.getClass() + " and target class: " + collClass);</a>
<span class="sourceLineNo">736</span><a id="line.736">        return result;</a>
<span class="sourceLineNo">737</span><a id="line.737">    }</a>
<span class="sourceLineNo">738</span><a id="line.738">}</a>
<span class="sourceLineNo">739</span><a id="line.739"></a>
<span class="sourceLineNo">740</span><a id="line.740">abstract class TextClassMixin {</a>
<span class="sourceLineNo">741</span><a id="line.741"></a>
<span class="sourceLineNo">742</span><a id="line.742">    @JsonIgnore</a>
<span class="sourceLineNo">743</span><a id="line.743">    abstract Map&lt;String, Object&gt; getContainer();</a>
<span class="sourceLineNo">744</span><a id="line.744">}</a>




























































</pre>
</div>
</main>
</body>
</html>
